{"version":3,"sources":["../src/medias/medias.constants.ts","../src/medias/medias.controller.ts","../src/medias/services/medias-logger.service.ts","../src/medias/services/medias-storage.service.ts","../src/medias/services/medias-validation.service.ts","../src/medias/services/medias-resize.service.ts","../src/medias/medias.service.ts","../src/medias/medias.module.ts","../src/medias/dto/delete-media.dto.ts","../src/medias/dto/get-media.dto.ts"],"names":["Logger","InternalServerErrorException","NotFoundException","Injectable","Inject","BadRequestException","etag","durationMs","sharp","commonFileNameRefinements","strictFilenameRefinement","looseFilenameRefinement","z","createZodDto"],"mappings":"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","file":"index.mjs","sourcesContent":["export const MEDIAS_MODULE_OPTIONS = 'MEDIAS_MODULE_OPTIONS';\n\n/**\n * Image extensions supported by Sharp for resizing\n */\nexport const RESIZABLE_IMAGE_EXTENSIONS = ['.png', '.jpg', '.jpeg', '.gif', '.webp', '.avif', '.tiff'];\n\n/**\n * All image extensions (including non-resizable)\n */\nexport const IMAGE_EXTENSIONS = [...RESIZABLE_IMAGE_EXTENSIONS, '.svg', '.ico', '.bmp'];\n\n/**\n * Video extensions\n */\nexport const VIDEO_EXTENSIONS = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.mkv', '.m4v', '.wmv', '.flv'];\n\n/**\n * Audio extensions\n */\nexport const AUDIO_EXTENSIONS = ['.mp3', '.wav', '.flac', '.aac', '.m4a', '.ogg', '.wma', '.opus'];\n\n/**\n * Document extensions\n */\nexport const DOCUMENT_EXTENSIONS = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx', '.txt', '.rtf', '.csv'];\n\n/**\n * Archive extensions\n */\nexport const ARCHIVE_EXTENSIONS = ['.zip', '.rar', '.7z', '.tar', '.gz', '.bz2'];\n\n/**\n * All supported media extensions\n */\nexport const ALL_MEDIA_EXTENSIONS = [...IMAGE_EXTENSIONS, ...VIDEO_EXTENSIONS, ...AUDIO_EXTENSIONS, ...DOCUMENT_EXTENSIONS, ...ARCHIVE_EXTENSIONS];\n\n/**\n * MIME type mapping\n */\nexport const MIME_TYPES: Record<string, string> = {\n  // Images\n  '.png': 'image/png',\n  '.jpg': 'image/jpeg',\n  '.jpeg': 'image/jpeg',\n  '.gif': 'image/gif',\n  '.webp': 'image/webp',\n  '.svg': 'image/svg+xml',\n  '.ico': 'image/x-icon',\n  '.bmp': 'image/bmp',\n  '.tiff': 'image/tiff',\n  '.avif': 'image/avif',\n\n  // Videos\n  '.mp4': 'video/mp4',\n  '.webm': 'video/webm',\n  '.ogg': 'video/ogg',\n  '.mov': 'video/quicktime',\n  '.avi': 'video/x-msvideo',\n  '.mkv': 'video/x-matroska',\n  '.m4v': 'video/x-m4v',\n  '.wmv': 'video/x-ms-wmv',\n  '.flv': 'video/x-flv',\n\n  // Audio\n  '.mp3': 'audio/mpeg',\n  '.wav': 'audio/wav',\n  '.flac': 'audio/flac',\n  '.aac': 'audio/aac',\n  '.m4a': 'audio/mp4',\n  '.wma': 'audio/x-ms-wma',\n  '.opus': 'audio/opus',\n\n  // Documents\n  '.pdf': 'application/pdf',\n  '.doc': 'application/msword',\n  '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n  '.xls': 'application/vnd.ms-excel',\n  '.xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n  '.ppt': 'application/vnd.ms-powerpoint',\n  '.pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',\n  '.txt': 'text/plain',\n  '.rtf': 'application/rtf',\n  '.csv': 'text/csv',\n\n  // Archives\n  '.zip': 'application/zip',\n  '.rar': 'application/vnd.rar',\n  '.7z': 'application/x-7z-compressed',\n  '.tar': 'application/x-tar',\n  '.gz': 'application/gzip',\n  '.bz2': 'application/x-bzip2',\n};\n\n/**\n * Default configuration values\n */\n\n/** Default maximum width for image resizing in pixels */\nexport const DEFAULT_MAX_RESIZE_WIDTH = 1200;\n\n/** Size constants in bytes */\nconst BYTES_PER_KILOBYTE = 1024;\nconst KILOBYTES_PER_MEGABYTE = 1024;\nconst BYTES_PER_MEGABYTE = KILOBYTES_PER_MEGABYTE * BYTES_PER_KILOBYTE;\nconst DEFAULT_MAX_FILE_SIZE_MB = 15;\n\n/** Default maximum file size for on-the-fly resizing in bytes (15MB) */\nexport const DEFAULT_MAX_ORIGINAL_FILE_SIZE = DEFAULT_MAX_FILE_SIZE_MB * BYTES_PER_MEGABYTE;\n\n/** Size units for calculations */\nexport const SIZE_UNITS = {\n  KILOBYTE: BYTES_PER_KILOBYTE,\n  MEGABYTE: BYTES_PER_MEGABYTE,\n} as const;\n\n/**\n * Validation limits\n */\n\n/** Maximum length for file names */\nexport const MAX_FILENAME_LENGTH = 255;\n\n/** Maximum width for resize parameter validation */\nexport const MAX_RESIZE_WIDTH_LIMIT = 5000;\n\n/**\n * HTTP Status Codes\n */\nexport const HTTP_STATUS = {\n  NOT_MODIFIED: 304,\n  INTERNAL_SERVER_ERROR: 500,\n} as const;\n\n/**\n * Image format options for conversion\n */\nexport type ImageFormat = 'original' | 'jpeg' | 'webp' | 'avif';\n\n/**\n * Image quality settings by format\n */\nexport const IMAGE_QUALITY = {\n  JPEG: 85,\n  WEBP: 80,\n  AVIF: 75,\n} as const;\n\n/**\n * Format priority for content negotiation (higher = preferred)\n */\nexport const FORMAT_PRIORITY: Record<ImageFormat, number> = {\n  avif: 3,\n  webp: 2,\n  jpeg: 1,\n  original: 0,\n};\n\n/**\n * Retry configuration for S3 operations\n */\nexport const RETRY_CONFIG = {\n  /** Maximum number of retry attempts */\n  MAX_ATTEMPTS: 3,\n  /** Initial backoff delay in milliseconds */\n  INITIAL_BACKOFF_MS: 50,\n  /** Backoff multiplier for each retry attempt */\n  BACKOFF_MULTIPLIER: 2,\n} as const;\n\n/**\n * S3 error codes that should trigger a retry\n */\nexport const TRANSIENT_S3_ERROR_CODES = [\n  'RequestTimeout',\n  'RequestTimeoutException',\n  'PriorRequestNotComplete',\n  'ConnectionError',\n  'NetworkingError',\n  'SlowDown',\n  'ServiceUnavailable',\n  'InternalError',\n];\n\n/**\n * S3 metadata keys for enriched file information\n */\nexport const S3_METADATA_KEYS = {\n  WIDTH: 'x-amz-meta-width',\n  HEIGHT: 'x-amz-meta-height',\n  MIME_TYPE: 'x-amz-meta-mime',\n  ORIGINAL_NAME: 'x-amz-meta-original-name',\n  UPLOADED_AT: 'x-amz-meta-uploaded-at',\n} as const;\n","import { BadRequestException, Controller, Delete, Get, InternalServerErrorException, Logger, NotFoundException, Param, Query, Req, Res } from '@nestjs/common';\nimport { Request, Response } from 'express';\nimport { DeleteMediaParamsLooseDto } from './dto/delete-media.dto.js';\nimport { GetMediaParamsLooseDto, GetMediaQueryDto } from './dto/get-media.dto.js';\nimport { HTTP_STATUS } from './medias.constants.js';\nimport { MediasService } from './medias.service.js';\n\n@Controller('medias')\nexport class MediasController {\n  private readonly logger = new Logger(MediasController.name);\n\n  constructor(private readonly mediasService: MediasService) {}\n\n  @Get('*fileName')\n  async getMedia(@Param() params: GetMediaParamsLooseDto, @Query() query: GetMediaQueryDto, @Req() req: Request, @Res() res: Response): Promise<void> {\n    const startTime = Date.now();\n\n    // Wildcard params return an array in path-to-regexp v8\n    const fileName = Array.isArray(params.fileName) ? params.fileName.join('/') : params.fileName;\n    const { size } = query;\n    const ifNoneMatch = req.headers['if-none-match'] as string | undefined;\n    const acceptHeader = req.headers['accept'] as string | undefined;\n\n    try {\n      // If size is requested, attempt to resize (only works for images)\n      if (size && parseInt(size, 10) > 0) {\n        const requestedSize = parseInt(size, 10);\n\n        // Check if file is resizable before attempting\n        if (!this.mediasService.isResizable(fileName)) {\n          if (this.mediasService.isImage(fileName)) {\n            throw new BadRequestException(`This image format does not support resizing. Serve without size parameter.`);\n          }\n          throw new BadRequestException(`Cannot resize non-image files. Remove the size parameter to serve the file.`);\n        }\n\n        // Negotiate format based on Accept header\n        const format = this.mediasService.negotiateFormat(acceptHeader);\n\n        const result = await this.mediasService.getResizedImage(fileName, requestedSize, ifNoneMatch, format);\n\n        const duration = Date.now() - startTime;\n\n        if (result.notModified) {\n          res.setHeader('X-Processing-Time', `${duration}ms`);\n          res.setHeader('X-Cache', 'HIT');\n          res.setHeader('X-Resize', 'yes');\n          res.status(HTTP_STATUS.NOT_MODIFIED).end();\n          return;\n        }\n\n        // Add Vary: Accept for proper CDN caching\n        res.setHeader('Vary', 'Accept');\n        res.setHeader('X-Processing-Time', `${duration}ms`);\n        res.setHeader('X-Cache', 'MISS');\n        res.setHeader('X-Resize', 'yes');\n        res.setHeader('Content-Type', result.mimeType);\n        res.setHeader('Content-Length', result.buffer.length);\n        res.setHeader('Content-Disposition', `inline; filename=\"${fileName}\"`);\n        res.setHeader('ETag', result.etag);\n        res.setHeader('Cache-Control', 'public, max-age=31536000, immutable');\n        res.send(result.buffer);\n      } else {\n        // Serve original file (any media type)\n        const result = await this.mediasService.getMediaStream(fileName, ifNoneMatch);\n\n        const duration = Date.now() - startTime;\n\n        if (result.notModified) {\n          res.setHeader('X-Processing-Time', `${duration}ms`);\n          res.setHeader('X-Cache', 'HIT');\n          res.setHeader('X-Resize', 'no');\n          res.status(HTTP_STATUS.NOT_MODIFIED).end();\n          return;\n        }\n\n        res.setHeader('X-Processing-Time', `${duration}ms`);\n        res.setHeader('X-Cache', 'MISS');\n        res.setHeader('X-Resize', 'no');\n        res.setHeader('Content-Type', result.mimeType);\n        res.setHeader('Content-Length', result.size);\n        res.setHeader('Content-Disposition', `inline; filename=\"${fileName}\"`);\n        res.setHeader('ETag', result.etag);\n        res.setHeader('Cache-Control', 'public, max-age=31536000, immutable');\n        res.setHeader('Last-Modified', result.lastModified.toUTCString());\n\n        result.stream.pipe(res);\n\n        result.stream.on('error', (error) => {\n          this.logger.error(`Stream error: ${error.message}`);\n          if (!res.headersSent) {\n            res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).end();\n          }\n        });\n      }\n    } catch (error) {\n      if (error instanceof BadRequestException || error instanceof NotFoundException) {\n        throw error;\n      }\n      this.logger.error(`Error serving media: ${error instanceof Error ? error.message : 'Unknown error'}`);\n      throw new InternalServerErrorException('Error serving media');\n    }\n  }\n\n  @Delete('*fileName')\n  async deleteMedia(@Param() params: DeleteMediaParamsLooseDto): Promise<void> {\n    const fileName = Array.isArray(params.fileName) ? params.fileName.join('/') : params.fileName;\n    return this.mediasService.deleteMedia(fileName);\n  }\n}\n","import { Inject, Injectable, Logger } from '@nestjs/common';\nimport { MEDIAS_MODULE_OPTIONS } from '../medias.constants.js';\nimport { MediasLogLevel, MediasModuleOptions } from '../interfaces/medias-module-options.interface.js';\n\n// Log level priority for comparison\nconst LOG_LEVEL_PRIORITY: Record<MediasLogLevel, number> = {\n  none: -1,\n  fatal: 0,\n  error: 1,\n  warn: 2,\n  log: 3,\n  debug: 4,\n  verbose: 5,\n};\n\n/**\n * Internal logging service for the medias module\n * Provides configurable logging based on module options\n */\n@Injectable()\nexport class MediasLoggerService {\n  private readonly logger = new Logger('MediasModule');\n  private readonly logLevel: MediasLogLevel;\n\n  constructor(\n    @Inject(MEDIAS_MODULE_OPTIONS)\n    options: MediasModuleOptions,\n  ) {\n    this.logLevel = options.logLevel ?? 'none';\n  }\n\n  private shouldLog(level: MediasLogLevel): boolean {\n    return LOG_LEVEL_PRIORITY[level] <= LOG_LEVEL_PRIORITY[this.logLevel];\n  }\n\n  error(message: string, context?: Record<string, unknown>): void {\n    if (this.shouldLog('error')) {\n      this.logger.error(context ? `${message} ${JSON.stringify(context)}` : message);\n    }\n  }\n\n  warn(message: string, context?: Record<string, unknown>): void {\n    if (this.shouldLog('warn')) {\n      this.logger.warn(context ? `${message} ${JSON.stringify(context)}` : message);\n    }\n  }\n\n  info(message: string, context?: Record<string, unknown>): void {\n    if (this.shouldLog('log')) {\n      this.logger.log(context ? `${message} ${JSON.stringify(context)}` : message);\n    }\n  }\n\n  debug(message: string, context?: Record<string, unknown>): void {\n    if (this.shouldLog('debug')) {\n      this.logger.debug(context ? `${message} ${JSON.stringify(context)}` : message);\n    }\n  }\n\n  verbose(message: string, context?: Record<string, unknown>): void {\n    if (this.shouldLog('verbose')) {\n      this.logger.verbose(context ? `${message} ${JSON.stringify(context)}` : message);\n    }\n  }\n}\n","import { Inject, Injectable, InternalServerErrorException, NotFoundException } from '@nestjs/common';\nimport { MinioService } from 'nestjs-minio-client';\nimport { Readable } from 'stream';\nimport { MEDIAS_MODULE_OPTIONS, RETRY_CONFIG, TRANSIENT_S3_ERROR_CODES } from '../medias.constants.js';\nimport { MediasModuleOptions } from '../interfaces/medias-module-options.interface.js';\nimport { MediasLoggerService } from './medias-logger.service.js';\n\n/**\n * File stat information\n */\nexport interface MediaStatResult {\n  size: number;\n  lastModified: Date;\n  etag: string;\n  metaData: Record<string, string>;\n}\n\n/**\n * Internal storage service for S3/MinIO operations\n * Handles all direct interactions with the object storage\n */\n@Injectable()\nexport class MediasStorageService {\n  constructor(\n    private readonly minioService: MinioService,\n    @Inject(MEDIAS_MODULE_OPTIONS)\n    private readonly options: MediasModuleOptions,\n    private readonly logger: MediasLoggerService,\n  ) {\n    this.logger.verbose('MediasStorageService initialized', { bucket: options.s3.bucketName });\n  }\n\n  getBucketName(): string {\n    const bucketName = this.options.s3.bucketName;\n    if (!bucketName) {\n      this.logger.error('S3 bucket name not configured');\n      throw new InternalServerErrorException('S3 bucket name not configured');\n    }\n    return bucketName;\n  }\n\n  // ============================================\n  // Retry Logic\n  // ============================================\n\n  private isTransientError(error: unknown): boolean {\n    if (!error || typeof error !== 'object') {\n      return false;\n    }\n\n    const err = error as { code?: string; name?: string };\n    const errorCode = err.code ?? err.name ?? '';\n\n    return TRANSIENT_S3_ERROR_CODES.includes(errorCode);\n  }\n\n  private delay(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  }\n\n  async withRetry<T>(operation: () => Promise<T>, context: { operationName: string; fileName?: string }): Promise<T> {\n    let attempt = 0;\n\n    while (true) {\n      try {\n        this.logger.verbose(`Executing S3 operation (attempt ${attempt + 1}/${RETRY_CONFIG.MAX_ATTEMPTS})`, {\n          operation: context.operationName,\n          fileName: context.fileName,\n        });\n        return await operation();\n      } catch (error) {\n        attempt++;\n\n        const isTransient = this.isTransientError(error);\n        const shouldRetry = isTransient && attempt < RETRY_CONFIG.MAX_ATTEMPTS;\n\n        if (!shouldRetry) {\n          this.logger.error('S3 operation failed', {\n            operation: context.operationName,\n            fileName: context.fileName,\n            attempt,\n            isTransient,\n            error: error instanceof Error ? error.message : 'Unknown error',\n          });\n          throw error;\n        }\n\n        const backoffMs = RETRY_CONFIG.INITIAL_BACKOFF_MS * Math.pow(RETRY_CONFIG.BACKOFF_MULTIPLIER, attempt - 1);\n        this.logger.warn('Transient S3 error, retrying', {\n          operation: context.operationName,\n          fileName: context.fileName,\n          attempt,\n          retryAfterMs: backoffMs,\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n\n        await this.delay(backoffMs);\n      }\n    }\n  }\n\n  // ============================================\n  // Storage Operations\n  // ============================================\n\n  async getFileStream(fileName: string): Promise<Readable> {\n    this.logger.verbose('Fetching file stream from S3', { fileName, bucket: this.getBucketName() });\n    try {\n      const fileStream = await this.withRetry(\n        () => this.minioService.client.getObject(this.getBucketName(), fileName) as Promise<Readable>,\n        { operationName: 'getObject', fileName },\n      );\n      this.logger.verbose('File stream obtained', { fileName });\n      return fileStream;\n    } catch (error) {\n      this.logger.error('File not found in S3', { fileName, error: error instanceof Error ? error.message : 'Unknown error' });\n      throw new NotFoundException(`File with name ${fileName} not found`);\n    }\n  }\n\n  async getFile(fileName: string): Promise<Buffer> {\n    this.logger.verbose('Loading file into buffer', { fileName });\n\n    try {\n      const fileStream = await this.getFileStream(fileName);\n\n      return new Promise((resolve, reject) => {\n        const chunks: Buffer[] = [];\n\n        fileStream.on('data', (chunk: Buffer) => {\n          chunks.push(chunk);\n        });\n\n        fileStream.on('end', () => {\n          const buffer = Buffer.concat(chunks);\n          this.logger.debug('File loaded into buffer', { fileName, size: buffer.length });\n          resolve(buffer);\n        });\n\n        fileStream.on('error', (error) => {\n          this.logger.error('Error reading file stream', { fileName, error: error.message });\n          reject(error);\n        });\n      });\n    } catch (error) {\n      if (error instanceof NotFoundException) {\n        throw error;\n      }\n      this.logger.error('Failed to get file', { fileName, error: error instanceof Error ? error.message : 'Unknown error' });\n      throw new NotFoundException(`File with name ${fileName} not found`);\n    }\n  }\n\n  async getFileStat(fileName: string): Promise<MediaStatResult> {\n    this.logger.verbose('Fetching file stat from S3', { fileName });\n    try {\n      const stat = await this.withRetry(() => this.minioService.client.statObject(this.getBucketName(), fileName), { operationName: 'statObject', fileName });\n      this.logger.verbose('File stat obtained', { fileName, size: stat.size });\n      return stat;\n    } catch (error) {\n      this.logger.error('File stat not found', { fileName, error: error instanceof Error ? error.message : 'Unknown error' });\n      throw new NotFoundException(`File with name ${fileName} not found`);\n    }\n  }\n\n  async putFile(fileName: string, file: Buffer, metadata?: Record<string, string>): Promise<void> {\n    this.logger.verbose('Uploading file to S3', { fileName, size: file.length });\n    await this.withRetry(\n      () => (metadata ? this.minioService.client.putObject(this.getBucketName(), fileName, file, metadata) : this.minioService.client.putObject(this.getBucketName(), fileName, file)),\n      { operationName: 'putObject', fileName },\n    );\n    this.logger.info('File uploaded to S3', { fileName, size: file.length });\n  }\n\n  async deleteFile(fileName: string): Promise<void> {\n    this.logger.verbose('Deleting file from S3', { fileName });\n    await this.withRetry(() => this.minioService.client.removeObject(this.getBucketName(), fileName), { operationName: 'removeObject', fileName });\n    this.logger.info('File deleted from S3', { fileName });\n  }\n}\n","import { BadRequestException, Inject, Injectable } from '@nestjs/common';\nimport * as crypto from 'crypto';\nimport * as path from 'path';\nimport { DEFAULT_MAX_RESIZE_WIDTH, IMAGE_EXTENSIONS, MIME_TYPES, RESIZABLE_IMAGE_EXTENSIONS, MEDIAS_MODULE_OPTIONS } from '../medias.constants.js';\nimport { MediasModuleOptions } from '../interfaces/medias-module-options.interface.js';\nimport { MediasLoggerService } from './medias-logger.service.js';\n\n/**\n * Internal validation service for the medias module\n * Handles file type checking, size validation, and utility functions\n */\n@Injectable()\nexport class MediasValidationService {\n  constructor(\n    @Inject(MEDIAS_MODULE_OPTIONS)\n    private readonly options: MediasModuleOptions,\n    private readonly logger: MediasLoggerService,\n  ) {}\n\n  // ============================================\n  // File Type Checking\n  // ============================================\n\n  /**\n   * Check if file is an image based on extension\n   */\n  isImage(fileName: string): boolean {\n    const ext = path.extname(fileName).toLowerCase();\n    return IMAGE_EXTENSIONS.includes(ext);\n  }\n\n  /**\n   * Check if file can be resized (Sharp-compatible image)\n   */\n  isResizable(fileName: string): boolean {\n    const ext = path.extname(fileName).toLowerCase();\n    return RESIZABLE_IMAGE_EXTENSIONS.includes(ext);\n  }\n\n  /**\n   * Get MIME type from file extension\n   */\n  getMimeType(ext: string): string {\n    return MIME_TYPES[ext.toLowerCase()] || 'application/octet-stream';\n  }\n\n  // ============================================\n  // Validation Methods\n  // ============================================\n\n  /**\n   * Validate that a file can be resized\n   * @throws BadRequestException if file is not resizable\n   */\n  validateResizable(fileName: string): void {\n    if (!this.isResizable(fileName)) {\n      const ext = path.extname(fileName).toLowerCase();\n      if (this.isImage(fileName)) {\n        this.logger.warn('Attempted to resize unsupported image format', { fileName, ext });\n        throw new BadRequestException(`Image format ${ext} does not support resizing. Supported formats: ${RESIZABLE_IMAGE_EXTENSIONS.join(', ')}`);\n      }\n      this.logger.warn('Attempted to resize non-image file', { fileName });\n      throw new BadRequestException(`Cannot resize non-image file ${fileName}. Resize is only supported for images.`);\n    }\n  }\n\n  /**\n   * Validate that resize size is within allowed limits\n   * @throws BadRequestException if size exceeds maxResizeWidth\n   */\n  validateResizeSize(fileName: string, size: number): void {\n    const maxWidth = this.options.maxResizeWidth ?? DEFAULT_MAX_RESIZE_WIDTH;\n    if (size > maxWidth) {\n      this.logger.warn('Resize size exceeds maximum', { fileName, size, maxWidth });\n      throw new BadRequestException(`Size cannot exceed ${maxWidth} pixels`);\n    }\n  }\n\n  // ============================================\n  // ETag Generation\n  // ============================================\n\n  /**\n   * Generate ETag from file metadata\n   */\n  generateETag(fileName: string, lastModified: Date, size: number): string {\n    const hash = crypto.createHash('md5').update(`${fileName}-${lastModified.getTime()}-${size}`).digest('hex');\n    return `\"${hash}\"`;\n  }\n\n  /**\n   * Generate ETag from buffer content\n   */\n  generateETagFromBuffer(buffer: Buffer): string {\n    const hash = crypto.createHash('md5').update(buffer).digest('hex');\n    return `\"${hash}\"`;\n  }\n\n  // ============================================\n  // Path Utilities\n  // ============================================\n\n  /**\n   * Build resized file name from original\n   */\n  buildResizedFileName(fileName: string, size: number, outputExt: string): string {\n    const ext = path.extname(fileName);\n    const baseName = path.basename(fileName, ext);\n    const dirName = path.dirname(fileName);\n    return dirName === '.' ? `${baseName}-${size}${outputExt}` : `${dirName}/${baseName}-${size}${outputExt}`;\n  }\n\n  /**\n   * Get file extension\n   */\n  getExtension(fileName: string): string {\n    return path.extname(fileName);\n  }\n\n  /**\n   * Get max resize width from options\n   */\n  getMaxResizeWidth(): number {\n    return this.options.maxResizeWidth ?? DEFAULT_MAX_RESIZE_WIDTH;\n  }\n\n  /**\n   * Check if auto prevent upscale is enabled\n   */\n  isAutoPreventUpscaleEnabled(): boolean {\n    return this.options.autoPreventUpscale ?? true;\n  }\n}\n","import { BadRequestException, Inject, Injectable } from '@nestjs/common';\nimport sharp, { Sharp } from 'sharp';\nimport { Readable } from 'stream';\nimport { DEFAULT_MAX_ORIGINAL_FILE_SIZE, IMAGE_QUALITY, ImageFormat, MEDIAS_MODULE_OPTIONS, SIZE_UNITS } from '../medias.constants.js';\nimport { MediasModuleOptions } from '../interfaces/medias-module-options.interface.js';\nimport { MediasLoggerService } from './medias-logger.service.js';\nimport { MediasStorageService } from './medias-storage.service.js';\nimport { MediasValidationService } from './medias-validation.service.js';\n\n/**\n * Response type for buffered media\n */\nexport interface MediaBufferResponse {\n  buffer: Buffer;\n  mimeType: string;\n  etag: string;\n  notModified?: boolean;\n}\n\n/**\n * Response type for streaming media\n */\nexport interface MediaStreamResponse {\n  stream: Readable;\n  mimeType: string;\n  size: number;\n  etag: string;\n  lastModified: Date;\n  notModified?: boolean;\n}\n\n/**\n * Request item for batch resize operation\n */\nexport interface BatchResizeRequestItem {\n  fileName: string;\n  sizes: number[];\n}\n\n/**\n * Result item for batch resize operation\n */\nexport interface BatchResizeResultItem {\n  fileName: string;\n  size: number;\n  resizedFileName: string;\n  success: boolean;\n  error?: string;\n}\n\n/**\n * Internal result for single variant generation\n */\ninterface GenerateVariantResult {\n  resizedFileName: string;\n  success: boolean;\n  error?: string;\n}\n\n/**\n * Internal resize service for the medias module\n * Handles all image resizing operations\n */\n@Injectable()\nexport class MediasResizeService {\n  constructor(\n    @Inject(MEDIAS_MODULE_OPTIONS)\n    private readonly options: MediasModuleOptions,\n    private readonly logger: MediasLoggerService,\n    private readonly storage: MediasStorageService,\n    private readonly validation: MediasValidationService,\n  ) {}\n\n  // ============================================\n  // Format Helpers\n  // ============================================\n\n  private applyFormat(pipeline: Sharp, format: ImageFormat): Sharp {\n    switch (format) {\n      case 'webp':\n        return pipeline.webp({ quality: IMAGE_QUALITY.WEBP });\n      case 'jpeg':\n        return pipeline.jpeg({ quality: IMAGE_QUALITY.JPEG });\n      case 'avif':\n        return pipeline.avif({ quality: IMAGE_QUALITY.AVIF });\n      case 'original':\n      default:\n        return pipeline;\n    }\n  }\n\n  getMimeTypeForFormat(format: ImageFormat, originalExt: string): string {\n    switch (format) {\n      case 'webp':\n        return 'image/webp';\n      case 'jpeg':\n        return 'image/jpeg';\n      case 'avif':\n        return 'image/avif';\n      case 'original':\n      default:\n        return this.validation.getMimeType(originalExt);\n    }\n  }\n\n  getExtensionForFormat(format: ImageFormat, originalExt: string): string {\n    switch (format) {\n      case 'webp':\n        return '.webp';\n      case 'jpeg':\n        return '.jpg';\n      case 'avif':\n        return '.avif';\n      case 'original':\n      default:\n        return originalExt;\n    }\n  }\n\n  /**\n   * Negotiate the best image format based on Accept header\n   */\n  negotiateFormat(acceptHeader?: string): ImageFormat {\n    if (!this.options.enableContentNegotiation) {\n      return this.options.preferredFormat ?? 'original';\n    }\n\n    if (!acceptHeader) {\n      return this.options.preferredFormat ?? 'original';\n    }\n\n    const accept = acceptHeader.toLowerCase();\n    const allowAvif = this.options.allowAvif ?? true;\n    const allowWebp = this.options.allowWebp ?? true;\n\n    if (allowAvif && accept.includes('image/avif')) {\n      this.logger.debug('Content negotiation: AVIF selected', { acceptHeader });\n      return 'avif';\n    }\n\n    if (allowWebp && accept.includes('image/webp')) {\n      this.logger.debug('Content negotiation: WebP selected', { acceptHeader });\n      return 'webp';\n    }\n\n    if (accept.includes('image/jpeg') || accept.includes('image/*') || accept.includes('*/*')) {\n      this.logger.debug('Content negotiation: JPEG selected as fallback', { acceptHeader });\n      return 'jpeg';\n    }\n\n    this.logger.debug('Content negotiation: original format selected', { acceptHeader });\n    return 'original';\n  }\n\n  // ============================================\n  // Single Variant Generation\n  // ============================================\n\n  /**\n   * Generate a single image variant\n   * Shared logic used by preGenerate and batchResize\n   */\n  async generateVariant(\n    fileName: string,\n    buffer: Buffer,\n    size: number,\n    originalWidth?: number,\n    skipUpload = false,\n  ): Promise<GenerateVariantResult> {\n    const maxWidth = this.validation.getMaxResizeWidth();\n    const autoPreventUpscale = this.validation.isAutoPreventUpscaleEnabled();\n\n    const ext = this.validation.getExtension(fileName);\n    const outputFormat = this.options.preferredFormat ?? 'original';\n    const outputExt = this.getExtensionForFormat(outputFormat, ext);\n    const resizedFileName = this.validation.buildResizedFileName(fileName, size, outputExt);\n\n    // Validate size against maxWidth\n    if (size > maxWidth) {\n      const error = `Size ${size} exceeds maxResizeWidth (${maxWidth})`;\n      this.logger.warn('Variant generation skipped: size exceeds maxResizeWidth', {\n        fileName,\n        size,\n        maxWidth,\n      });\n      return { resizedFileName, success: false, error };\n    }\n\n    // Prevent upscaling if enabled\n    let finalSize = size;\n    if (autoPreventUpscale && originalWidth && size > originalWidth) {\n      this.logger.debug('Variant size exceeds original width, clamping', {\n        fileName,\n        requestedSize: size,\n        originalWidth,\n      });\n      finalSize = originalWidth;\n    }\n\n    try {\n      this.logger.verbose('Generating variant', {\n        fileName,\n        size,\n        finalSize,\n        resizedFileName,\n      });\n\n      let pipeline = sharp(buffer).resize(finalSize);\n      pipeline = this.applyFormat(pipeline, outputFormat);\n      const resizedBuffer = await pipeline.toBuffer();\n\n      if (!skipUpload) {\n        await this.storage.putFile(resizedFileName, resizedBuffer);\n      }\n\n      this.logger.info('Variant created', {\n        fileName,\n        size,\n        resizedFileName,\n        resizedSize: resizedBuffer.length,\n      });\n\n      return { resizedFileName, success: true };\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      this.logger.warn('Failed to generate variant', {\n        fileName,\n        size,\n        error: errorMessage,\n      });\n      return { resizedFileName, success: false, error: errorMessage };\n    }\n  }\n\n  // ============================================\n  // Resize Methods\n  // ============================================\n\n  /**\n   * Get resized image with automatic caching\n   */\n  async getResizedImage(fileName: string, size: number, ifNoneMatch?: string, format?: ImageFormat): Promise<MediaBufferResponse> {\n    const startTime = Date.now();\n    const outputFormat = format ?? this.options.preferredFormat ?? 'original';\n\n    this.logger.verbose('getResizedImage called', { fileName, size, outputFormat, hasIfNoneMatch: !!ifNoneMatch });\n\n    // Validate\n    this.validation.validateResizable(fileName);\n    this.validation.validateResizeSize(fileName, size);\n\n    // Check original file size\n    const stat = await this.storage.getFileStat(fileName);\n    const maxOriginalSize = this.options.maxOriginalFileSize ?? DEFAULT_MAX_ORIGINAL_FILE_SIZE;\n    if (maxOriginalSize > 0 && stat.size > maxOriginalSize) {\n      this.logger.warn('Original image too large for on-the-fly resize', {\n        fileName,\n        size: stat.size,\n        maxOriginalSize,\n      });\n      throw new BadRequestException(\n        `Image too large to resize on-the-fly (${Math.round(stat.size / SIZE_UNITS.MEGABYTE)}MB). Maximum allowed: ${Math.round(maxOriginalSize / SIZE_UNITS.MEGABYTE)}MB.`,\n      );\n    }\n\n    const ext = this.validation.getExtension(fileName);\n    const outputExt = this.getExtensionForFormat(outputFormat, ext);\n    const mimeType = this.getMimeTypeForFormat(outputFormat, ext);\n    const resizedFileName = this.validation.buildResizedFileName(fileName, size, outputExt);\n\n    this.logger.verbose('Computed resized file name', { originalFileName: fileName, resizedFileName, size, outputFormat });\n\n    // Try to get cached resized image\n    this.logger.verbose('Checking for cached resized image', { resizedFileName });\n    try {\n      const cachedStat = await this.storage.getFileStat(resizedFileName);\n      const etag = this.validation.generateETag(resizedFileName, cachedStat.lastModified, cachedStat.size);\n      this.logger.debug('Cached resized image found', { resizedFileName, size: cachedStat.size, etag });\n\n      if (ifNoneMatch === etag) {\n        this.logger.debug('Cache hit on resized image - returning 304 Not Modified', { resizedFileName, etag });\n        this.options.onCacheHit?.({ fileName: resizedFileName, size, notModified: true });\n        return { buffer: null as unknown as Buffer, mimeType, etag, notModified: true };\n      }\n\n      this.logger.info('Serving cached resized image', { resizedFileName, size: cachedStat.size });\n      const buffer = await this.storage.getFile(resizedFileName);\n      const durationMs = Date.now() - startTime;\n\n      this.options.onCacheHit?.({ fileName: resizedFileName, size, notModified: false });\n      this.options.onImageResized?.({\n        originalFileName: fileName,\n        resizedFileName,\n        requestedSize: size,\n        finalSize: buffer.length,\n        fromCache: true,\n        durationMs,\n        format: outputFormat,\n      });\n\n      return { buffer, mimeType, etag, notModified: false };\n    } catch {\n      this.logger.debug('No cached resized image found, will generate', { resizedFileName });\n    }\n\n    // Generate resized image\n    this.logger.verbose('Fetching original image for resize', { fileName });\n    const originalFile = await this.storage.getFile(fileName);\n    this.logger.debug('Original image loaded', { fileName, originalSize: originalFile.length });\n\n    // Check original dimensions and prevent upscaling if enabled\n    const autoPreventUpscale = this.validation.isAutoPreventUpscaleEnabled();\n    let finalSize = size;\n\n    if (autoPreventUpscale) {\n      const metadata = await sharp(originalFile).metadata();\n      if (metadata.width && size > metadata.width) {\n        this.logger.debug('Requested size exceeds original width, preventing upscale', {\n          fileName,\n          requestedSize: size,\n          originalWidth: metadata.width,\n        });\n        finalSize = metadata.width;\n      }\n    }\n\n    this.logger.verbose('Resizing image with Sharp', { fileName, targetWidth: finalSize, outputFormat });\n    let pipeline = sharp(originalFile).resize(finalSize);\n    pipeline = this.applyFormat(pipeline, outputFormat);\n    const resizedBuffer = await pipeline.toBuffer();\n    const etag = this.validation.generateETagFromBuffer(resizedBuffer);\n    this.logger.debug('Image resized', { fileName, originalSize: originalFile.length, resizedSize: resizedBuffer.length, outputFormat, etag });\n\n    if (ifNoneMatch === etag) {\n      this.logger.debug('Generated image matches ETag - returning 304 Not Modified', { fileName, etag });\n      return { buffer: null as unknown as Buffer, mimeType, etag, notModified: true };\n    }\n\n    // Upload to S3 asynchronously (fire-and-forget)\n    this.logger.verbose('Caching resized image to S3 (async)', { resizedFileName });\n    this.storage.putFile(resizedFileName, resizedBuffer).catch((error) => {\n      this.logger.warn('Failed to cache resized image', { resizedFileName, error: error instanceof Error ? error.message : 'Unknown error' });\n    });\n\n    const durationMs = Date.now() - startTime;\n\n    this.options.onImageResized?.({\n      originalFileName: fileName,\n      resizedFileName,\n      requestedSize: size,\n      finalSize: resizedBuffer.length,\n      fromCache: false,\n      durationMs,\n      format: outputFormat,\n    });\n\n    this.logger.info('Serving freshly resized image', { fileName, size, resizedSize: resizedBuffer.length });\n    return { buffer: resizedBuffer, mimeType, etag, notModified: false };\n  }\n\n  /**\n   * Get resized image as a stream (low-memory mode)\n   */\n  async getResizedImageStream(fileName: string, size: number, ifNoneMatch?: string, format?: ImageFormat): Promise<MediaStreamResponse> {\n    const outputFormat = format ?? this.options.preferredFormat ?? 'original';\n\n    this.logger.verbose('getResizedImageStream called', { fileName, size, outputFormat, hasIfNoneMatch: !!ifNoneMatch });\n\n    // Validate\n    this.validation.validateResizable(fileName);\n    this.validation.validateResizeSize(fileName, size);\n\n    // Get original file metadata for ETag generation\n    const stat = await this.storage.getFileStat(fileName);\n    const etag = this.validation.generateETag(`${fileName}-${size}-${outputFormat}`, stat.lastModified, stat.size);\n    this.logger.debug('Generated ETag for streaming resize', { fileName, size, etag });\n\n    // Check for 304 Not Modified\n    if (ifNoneMatch === etag) {\n      this.logger.debug('Cache hit - returning 304 Not Modified', { fileName, size, etag });\n      this.options.onCacheHit?.({ fileName, size, notModified: true });\n\n      return {\n        stream: null as unknown as Readable,\n        mimeType: this.getMimeTypeForFormat(outputFormat, this.validation.getExtension(fileName)),\n        size: 0,\n        etag,\n        lastModified: stat.lastModified,\n        notModified: true,\n      };\n    }\n\n    // Get original image stream\n    this.logger.verbose('Fetching original image stream for resize', { fileName });\n    const originalStream = await this.storage.getFileStream(fileName);\n\n    // Create Sharp resize pipeline\n    this.logger.verbose('Creating streaming resize pipeline', { fileName, size, outputFormat });\n    let resizePipeline = sharp().resize(size);\n    resizePipeline = this.applyFormat(resizePipeline, outputFormat);\n\n    // Pipe original stream through Sharp\n    const resizedStream = originalStream.pipe(resizePipeline);\n    const mimeType = this.getMimeTypeForFormat(outputFormat, this.validation.getExtension(fileName));\n\n    this.logger.info('Serving streaming resized image', { fileName, size, outputFormat });\n\n    return {\n      stream: resizedStream,\n      mimeType,\n      size: 0,\n      etag,\n      lastModified: stat.lastModified,\n      notModified: false,\n    };\n  }\n\n  // ============================================\n  // Batch Operations\n  // ============================================\n\n  /**\n   * Pre-generate image variants inline\n   */\n  async preGenerateInline(fileName: string, buffer: Buffer, sizes: number[]): Promise<void> {\n    if (!this.validation.isResizable(fileName)) {\n      this.logger.debug('File is not resizable, skipping pre-generation', { fileName });\n      return;\n    }\n\n    let originalWidth: number | undefined;\n    try {\n      const metadata = await sharp(buffer).metadata();\n      originalWidth = metadata.width;\n      this.logger.debug('Original image metadata for pre-generation', {\n        fileName,\n        width: originalWidth,\n        height: metadata.height,\n      });\n    } catch (error) {\n      this.logger.warn('Failed to get original image metadata for pre-generation', {\n        fileName,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      return;\n    }\n\n    const outputFormat = this.options.preferredFormat ?? 'original';\n\n    this.logger.info('Starting pre-generation of image variants', {\n      fileName,\n      sizes,\n      outputFormat,\n      originalWidth,\n    });\n\n    for (const size of sizes) {\n      await this.generateVariant(fileName, buffer, size, originalWidth);\n    }\n\n    this.logger.info('Pre-generation completed', { fileName, totalSizes: sizes.length });\n  }\n\n  /**\n   * Batch resize multiple images with multiple sizes\n   */\n  async batchResize(items: BatchResizeRequestItem[]): Promise<BatchResizeResultItem[]> {\n    this.logger.info('Starting batch resize operation', {\n      totalItems: items.length,\n      totalVariants: items.reduce((sum, item) => sum + item.sizes.length, 0),\n    });\n\n    const results: BatchResizeResultItem[] = [];\n\n    for (const item of items) {\n      const { fileName, sizes } = item;\n\n      this.logger.verbose('Processing batch item', { fileName, sizes });\n\n      // Check if file is resizable\n      if (!this.validation.isResizable(fileName)) {\n        const error = this.validation.isImage(fileName) ? `Image format not supported for resizing` : `File is not an image`;\n\n        this.logger.warn('Batch item skipped: not resizable', { fileName, error });\n\n        for (const size of sizes) {\n          const ext = this.validation.getExtension(fileName);\n          const outputExt = this.getExtensionForFormat(this.options.preferredFormat ?? 'original', ext);\n          const resizedFileName = this.validation.buildResizedFileName(fileName, size, outputExt);\n\n          results.push({ fileName, size, resizedFileName, success: false, error });\n        }\n        continue;\n      }\n\n      // Load original image\n      let buffer: Buffer;\n      try {\n        buffer = await this.storage.getFile(fileName);\n        this.logger.debug('Original image loaded for batch resize', { fileName, size: buffer.length });\n      } catch (error) {\n        const errorMessage = error instanceof Error ? error.message : 'File not found';\n        this.logger.error('Failed to load original for batch resize', { fileName, error: errorMessage });\n\n        for (const size of sizes) {\n          const ext = this.validation.getExtension(fileName);\n          const outputExt = this.getExtensionForFormat(this.options.preferredFormat ?? 'original', ext);\n          const resizedFileName = this.validation.buildResizedFileName(fileName, size, outputExt);\n\n          results.push({ fileName, size, resizedFileName, success: false, error: errorMessage });\n        }\n        continue;\n      }\n\n      // Get original dimensions for upscale prevention\n      let originalWidth: number | undefined;\n      try {\n        const metadata = await sharp(buffer).metadata();\n        originalWidth = metadata.width;\n        this.logger.debug('Original image metadata for batch resize', {\n          fileName,\n          width: originalWidth,\n          height: metadata.height,\n        });\n      } catch (error) {\n        this.logger.warn('Failed to get metadata for batch resize, proceeding without upscale prevention', {\n          fileName,\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n      }\n\n      // Generate each size\n      for (const size of sizes) {\n        const variantResult = await this.generateVariant(fileName, buffer, size, originalWidth);\n\n        results.push({\n          fileName,\n          size,\n          resizedFileName: variantResult.resizedFileName,\n          success: variantResult.success,\n          error: variantResult.error,\n        });\n      }\n    }\n\n    const successCount = results.filter((r) => r.success).length;\n    const failureCount = results.filter((r) => !r.success).length;\n\n    this.logger.info('Batch resize operation completed', {\n      totalItems: items.length,\n      totalVariants: results.length,\n      successCount,\n      failureCount,\n    });\n\n    return results;\n  }\n}\n","import { BadRequestException, Inject, Injectable } from '@nestjs/common';\nimport sharp from 'sharp';\nimport { Readable } from 'stream';\nimport { ImageFormat, MEDIAS_MODULE_OPTIONS, S3_METADATA_KEYS } from './medias.constants.js';\nimport { MediasModuleOptions } from './interfaces/medias-module-options.interface.js';\nimport {\n  MediasLoggerService,\n  MediasStorageService,\n  MediasValidationService,\n  MediasResizeService,\n  MediaStatResult,\n  MediaBufferResponse,\n  MediaStreamResponse,\n  BatchResizeRequestItem,\n  BatchResizeResultItem,\n} from './services/index.js';\n\n// Re-export types for backward compatibility\nexport { MediaStatResult, MediaBufferResponse, MediaStreamResponse, BatchResizeRequestItem, BatchResizeResultItem };\n\n/**\n * Main service for media storage, retrieval, and image resizing\n *\n * This is the public facade that consumers should use.\n * Internal logic is delegated to specialized services.\n */\n@Injectable()\nexport class MediasService {\n  constructor(\n    @Inject(MEDIAS_MODULE_OPTIONS)\n    private readonly options: MediasModuleOptions,\n    private readonly logger: MediasLoggerService,\n    private readonly storage: MediasStorageService,\n    private readonly validation: MediasValidationService,\n    private readonly resize: MediasResizeService,\n  ) {\n    this.logger.verbose('MediasService initialized', { bucket: options.s3.bucketName });\n  }\n\n  // ============================================\n  // Validation & Utilities (delegated)\n  // ============================================\n\n  /**\n   * Check if file is an image based on extension\n   */\n  isImage(fileName: string): boolean {\n    return this.validation.isImage(fileName);\n  }\n\n  /**\n   * Check if file can be resized (Sharp-compatible image)\n   */\n  isResizable(fileName: string): boolean {\n    return this.validation.isResizable(fileName);\n  }\n\n  /**\n   * Get MIME type from file extension\n   */\n  getMimeType(ext: string): string {\n    return this.validation.getMimeType(ext);\n  }\n\n  /**\n   * Generate ETag from file metadata\n   */\n  generateETag(fileName: string, lastModified: Date, size: number): string {\n    return this.validation.generateETag(fileName, lastModified, size);\n  }\n\n  /**\n   * Generate ETag from buffer content\n   */\n  generateETagFromBuffer(buffer: Buffer): string {\n    return this.validation.generateETagFromBuffer(buffer);\n  }\n\n  /**\n   * Negotiate the best image format based on Accept header\n   */\n  negotiateFormat(acceptHeader?: string): ImageFormat {\n    return this.resize.negotiateFormat(acceptHeader);\n  }\n\n  // ============================================\n  // Storage Operations (delegated)\n  // ============================================\n\n  /**\n   * Get any media file as a stream with metadata (memory-efficient)\n   */\n  async getMediaStream(fileName: string, ifNoneMatch?: string): Promise<MediaStreamResponse> {\n    this.logger.verbose('getMediaStream called', { fileName, hasIfNoneMatch: !!ifNoneMatch });\n\n    const ext = this.validation.getExtension(fileName);\n    const mimeType = this.validation.getMimeType(ext);\n    this.logger.verbose('Determined MIME type', { fileName, ext, mimeType });\n\n    this.logger.verbose('Fetching file stat', { fileName });\n    const stat = await this.storage.getFileStat(fileName);\n    const etag = this.validation.generateETag(fileName, stat.lastModified, stat.size);\n    this.logger.debug('File stat retrieved', { fileName, size: stat.size, etag });\n\n    if (ifNoneMatch === etag) {\n      this.logger.debug('Cache hit - returning 304 Not Modified', { fileName, etag });\n      this.options.onCacheHit?.({ fileName, size: 0, notModified: true });\n\n      return {\n        stream: null as unknown as Readable,\n        mimeType,\n        size: stat.size,\n        etag,\n        lastModified: stat.lastModified,\n        notModified: true,\n      };\n    }\n\n    this.logger.verbose('Cache miss - fetching file stream', { fileName });\n    const stream = await this.storage.getFileStream(fileName);\n    this.logger.info('Serving media stream', { fileName, size: stat.size, mimeType });\n\n    return {\n      stream,\n      mimeType,\n      size: stat.size,\n      etag,\n      lastModified: stat.lastModified,\n      notModified: false,\n    };\n  }\n\n  /**\n   * Get any media file as a buffer\n   * WARNING: Loads entire file into memory - not suitable for large files\n   */\n  async getMedia(fileName: string): Promise<Buffer> {\n    this.logger.warn('Loading entire file into memory', { fileName });\n    return this.storage.getFile(fileName);\n  }\n\n  /**\n   * Get raw file stream from S3\n   */\n  async getMediaFileStream(fileName: string): Promise<Readable> {\n    return this.storage.getFileStream(fileName);\n  }\n\n  /**\n   * Get file metadata (size, content-type, etc.)\n   */\n  async getMediaStat(fileName: string): Promise<MediaStatResult> {\n    return this.storage.getFileStat(fileName);\n  }\n\n  /**\n   * Upload any media file to S3\n   */\n  async uploadMedia(fileName: string, file: Buffer, originalName?: string, skipPreGeneration = false): Promise<void> {\n    this.logger.verbose('Uploading file to S3', { fileName, size: file.length, originalName, skipPreGeneration });\n\n    // Check if file is an image and extract metadata\n    if (this.validation.isImage(fileName)) {\n      try {\n        const metadata = await sharp(file).metadata();\n        const ext = this.validation.getExtension(fileName);\n        const mimeType = this.validation.getMimeType(ext);\n\n        const s3Metadata: Record<string, string> = {\n          [S3_METADATA_KEYS.MIME_TYPE]: mimeType,\n          [S3_METADATA_KEYS.UPLOADED_AT]: new Date().toISOString(),\n        };\n\n        if (metadata.width) {\n          s3Metadata[S3_METADATA_KEYS.WIDTH] = String(metadata.width);\n        }\n        if (metadata.height) {\n          s3Metadata[S3_METADATA_KEYS.HEIGHT] = String(metadata.height);\n        }\n        if (originalName) {\n          s3Metadata[S3_METADATA_KEYS.ORIGINAL_NAME] = originalName;\n        }\n\n        this.logger.debug('Uploading image with enriched metadata', {\n          fileName,\n          width: metadata.width,\n          height: metadata.height,\n          format: metadata.format,\n        });\n\n        await this.storage.putFile(fileName, file, s3Metadata);\n\n        this.logger.info('Image uploaded to S3 with metadata', {\n          fileName,\n          size: file.length,\n          dimensions: metadata.width && metadata.height ? `${metadata.width}x${metadata.height}` : undefined,\n        });\n\n        this.options.onUploaded?.({\n          fileName,\n          size: file.length,\n          isImage: true,\n          dimensions: metadata.width && metadata.height ? { width: metadata.width, height: metadata.height } : undefined,\n        });\n\n        // Trigger pre-generation if configured\n        if (!skipPreGeneration) {\n          await this.triggerPreGeneration(fileName, file);\n        }\n\n        return;\n      } catch (error) {\n        this.logger.warn('Failed to extract image metadata, uploading without enrichment', {\n          fileName,\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n      }\n    }\n\n    // Regular upload for non-images or if metadata extraction failed\n    await this.storage.putFile(fileName, file);\n\n    this.options.onUploaded?.({\n      fileName,\n      size: file.length,\n      isImage: false,\n    });\n\n    // Trigger pre-generation if configured\n    if (!skipPreGeneration) {\n      await this.triggerPreGeneration(fileName, file);\n    }\n  }\n\n  /**\n   * Trigger pre-generation of image variants\n   */\n  private async triggerPreGeneration(fileName: string, buffer: Buffer): Promise<void> {\n    const preGen = this.options.preGeneration;\n\n    if (!preGen || !preGen.sizes || preGen.sizes.length === 0) {\n      return;\n    }\n\n    if (!this.validation.isResizable(fileName)) {\n      this.logger.debug('File is not resizable, skipping pre-generation trigger', { fileName });\n      return;\n    }\n\n    this.logger.debug('Triggering pre-generation', {\n      fileName,\n      sizes: preGen.sizes,\n      hasDispatchJob: !!preGen.dispatchJob,\n    });\n\n    try {\n      if (preGen.dispatchJob) {\n        this.logger.info('Dispatching pre-generation job to external queue', {\n          fileName,\n          sizes: preGen.sizes,\n        });\n\n        await preGen.dispatchJob({ fileName, sizes: preGen.sizes });\n        this.logger.info('Pre-generation job dispatched successfully', { fileName });\n      } else {\n        this.logger.info('Starting inline pre-generation (fire-and-forget)', {\n          fileName,\n          sizes: preGen.sizes,\n        });\n\n        this.resize.preGenerateInline(fileName, buffer, preGen.sizes).catch((error) => {\n          this.logger.error('Inline pre-generation failed', {\n            fileName,\n            error: error instanceof Error ? error.message : 'Unknown error',\n          });\n        });\n      }\n    } catch (error) {\n      this.logger.error('Failed to trigger pre-generation', {\n        fileName,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n    }\n  }\n\n  /**\n   * Delete any media file from S3\n   */\n  async deleteMedia(fileName: string): Promise<void> {\n    return this.storage.deleteFile(fileName);\n  }\n\n  // ============================================\n  // Image Operations (delegated to resize service)\n  // ============================================\n\n  /**\n   * Get image as a stream with metadata\n   */\n  async getImageStream(fileName: string, ifNoneMatch?: string): Promise<MediaStreamResponse> {\n    this.logger.verbose('getImageStream called', { fileName });\n    if (!this.validation.isImage(fileName)) {\n      this.logger.warn('Attempted to get non-image file as image', { fileName });\n      throw new BadRequestException(`File ${fileName} is not an image. Use getMediaStream() for non-image files.`);\n    }\n    return this.getMediaStream(fileName, ifNoneMatch);\n  }\n\n  /**\n   * Get resized image with automatic caching\n   */\n  async getResizedImage(fileName: string, size: number, ifNoneMatch?: string, format?: ImageFormat): Promise<MediaBufferResponse> {\n    return this.resize.getResizedImage(fileName, size, ifNoneMatch, format);\n  }\n\n  /**\n   * Get resized image as a stream (low-memory mode)\n   */\n  async getResizedImageStream(fileName: string, size: number, ifNoneMatch?: string, format?: ImageFormat): Promise<MediaStreamResponse> {\n    return this.resize.getResizedImageStream(fileName, size, ifNoneMatch, format);\n  }\n\n  /**\n   * Batch resize multiple images with multiple sizes\n   */\n  async batchResize(items: BatchResizeRequestItem[]): Promise<BatchResizeResultItem[]> {\n    return this.resize.batchResize(items);\n  }\n}\n","import { DynamicModule, Module, Provider } from '@nestjs/common';\nimport { MinioModule } from 'nestjs-minio-client';\nimport { MEDIAS_MODULE_OPTIONS } from './medias.constants.js';\nimport { MediasController } from './medias.controller.js';\nimport { MediasService } from './medias.service.js';\nimport { MediasModuleAsyncOptions, MediasModuleOptions, MediasModuleOptionsFactory } from './interfaces/medias-module-options.interface.js';\nimport { MediasLoggerService, MediasStorageService, MediasValidationService, MediasResizeService } from './services/index.js';\n\n// Internal services (not exported)\nconst INTERNAL_SERVICES = [MediasLoggerService, MediasStorageService, MediasValidationService, MediasResizeService];\n\n@Module({})\nexport class MediasModule {\n  /**\n   * Register the medias module synchronously with provided options\n   * @param options Configuration options for the medias module\n   */\n  static forRoot(options: MediasModuleOptions): DynamicModule {\n    const controllers = options.registerController ? [MediasController] : [];\n\n    return {\n      module: MediasModule,\n      imports: [\n        MinioModule.register({\n          ...options.s3,\n        }),\n      ],\n      controllers,\n      providers: [\n        {\n          provide: MEDIAS_MODULE_OPTIONS,\n          useValue: options,\n        },\n        ...INTERNAL_SERVICES,\n        MediasService,\n      ],\n      exports: [MediasService],\n    };\n  }\n\n  /**\n   * Register the medias module asynchronously for dynamic configuration\n   * @param options Async configuration options\n   */\n  static forRootAsync(options: MediasModuleAsyncOptions): DynamicModule {\n    const controllers = options.registerController ? [MediasController] : [];\n\n    return {\n      module: MediasModule,\n      imports: [\n        ...(options.imports || []),\n        MinioModule.registerAsync({\n          useFactory: async (...args: unknown[]) => {\n            const moduleOptions = await this.createModuleOptions(options, ...args);\n            return moduleOptions.s3;\n          },\n          inject: options.inject || [],\n        }),\n      ],\n      controllers,\n      providers: [...this.createAsyncProviders(options), ...INTERNAL_SERVICES, MediasService],\n      exports: [MediasService],\n    };\n  }\n\n  private static createAsyncProviders(options: MediasModuleAsyncOptions): Provider[] {\n    if (options.useExisting || options.useFactory) {\n      return [this.createAsyncOptionsProvider(options)];\n    }\n\n    if (options.useClass) {\n      return [\n        this.createAsyncOptionsProvider(options),\n        {\n          provide: options.useClass,\n          useClass: options.useClass,\n        },\n      ];\n    }\n\n    return [];\n  }\n\n  private static createAsyncOptionsProvider(options: MediasModuleAsyncOptions): Provider {\n    if (options.useFactory) {\n      return {\n        provide: MEDIAS_MODULE_OPTIONS,\n        useFactory: options.useFactory,\n        inject: options.inject || [],\n      };\n    }\n\n    if (options.useExisting) {\n      return {\n        provide: MEDIAS_MODULE_OPTIONS,\n        useFactory: async (optionsFactory: MediasModuleOptionsFactory) => await optionsFactory.createMediasModuleOptions(),\n        inject: [options.useExisting],\n      };\n    }\n\n    if (options.useClass) {\n      return {\n        provide: MEDIAS_MODULE_OPTIONS,\n        useFactory: async (optionsFactory: MediasModuleOptionsFactory) => await optionsFactory.createMediasModuleOptions(),\n        inject: [options.useClass],\n      };\n    }\n\n    throw new Error('Invalid MediasModule configuration');\n  }\n\n  private static async createModuleOptions(options: MediasModuleAsyncOptions, ...args: unknown[]): Promise<MediasModuleOptions> {\n    if (options.useFactory) {\n      return await options.useFactory(...args);\n    }\n\n    if (options.useClass || options.useExisting) {\n      const factory = args[0] as MediasModuleOptionsFactory;\n      return await factory.createMediasModuleOptions();\n    }\n\n    throw new Error('Invalid MediasModule configuration');\n  }\n}\n","import { createZodDto } from 'nestjs-zod';\nimport { z } from 'zod';\nimport { ALL_MEDIA_EXTENSIONS, MAX_FILENAME_LENGTH } from '../medias.constants.js';\n\n/**\n * Common validation refinements for file names (security-critical, always applied)\n */\nconst commonFileNameRefinements = (schema: z.ZodString) =>\n  schema\n    .min(1, 'File name is required')\n    .max(MAX_FILENAME_LENGTH, 'File name is too long')\n    .refine(\n      (val) => {\n        // Prevent path traversal attacks\n        const sanitized = val.replace(/\\\\/g, '/');\n        return !sanitized.includes('../') && !sanitized.includes('/..') && !sanitized.startsWith('/');\n      },\n      {\n        message: 'Invalid file name - path traversal detected',\n      },\n    )\n    .refine(\n      (val) => {\n        // Ensure valid file extension\n        const ext = val.toLowerCase().match(/\\.[a-z0-9]+$/)?.[0];\n        return ext ? ALL_MEDIA_EXTENSIONS.includes(ext) : false;\n      },\n      {\n        message: `Invalid file extension - allowed extensions: ${ALL_MEDIA_EXTENSIONS.join(', ')}`,\n      },\n    );\n\n/**\n * Strict filename validation (whitelist approach - default)\n * Only allows: a-z, A-Z, 0-9, dots, hyphens, underscores, forward slashes\n */\nconst strictFilenameRefinement = (val: string) => /^[a-zA-Z0-9._/-]+$/.test(val);\n\n/**\n * Loose filename validation (blacklist approach)\n * Blocks only control characters (0x00-0x1F)\n * Allows: spaces, parentheses, apostrophes, Unicode, etc.\n */\n// eslint-disable-next-line no-control-regex\nconst looseFilenameRefinement = (val: string) => !/[\\x00-\\x1F]/.test(val);\n\n/**\n * Create a DeleteMediaParams schema with configurable strictness\n * @param strict - When true (default), uses whitelist validation. When false, uses blacklist (loose) validation.\n */\nexport const createDeleteMediaParamsSchema = (strict = true) =>\n  z.object({\n    fileName: commonFileNameRefinements(z.string()).refine(strict ? strictFilenameRefinement : looseFilenameRefinement, {\n      message: strict ? 'File name contains invalid characters - only alphanumeric, dots, hyphens, underscores, and slashes are allowed' : 'File name contains invalid control characters',\n    }),\n  });\n\n/**\n * Zod schema for delete media path parameters with strict security validation (default)\n * Uses whitelist approach - only alphanumeric, dots, hyphens, underscores, and slashes are allowed.\n * Security checks (path traversal, extensions) are always applied.\n *\n * For loose mode validation (backward compatibility with existing S3 files),\n * use createDeleteMediaParamsSchema(false) or DeleteMediaParamsLooseDto\n */\nconst DeleteMediaParamsSchema = createDeleteMediaParamsSchema(true);\n\n/**\n * Loose mode schema for backward compatibility with existing S3 files\n * Accepts Unicode, spaces, parentheses, etc.\n */\nconst DeleteMediaParamsLooseSchema = createDeleteMediaParamsSchema(false);\n\n/** Strict mode DTO (default) - only alphanumeric, dots, hyphens, underscores, slashes */\nexport class DeleteMediaParamsDto extends createZodDto(DeleteMediaParamsSchema) {}\n\n/** Loose mode DTO - accepts Unicode, spaces, parentheses, etc. */\nexport class DeleteMediaParamsLooseDto extends createZodDto(DeleteMediaParamsLooseSchema) {}\n","import { createZodDto } from 'nestjs-zod';\nimport { z } from 'zod';\nimport { ALL_MEDIA_EXTENSIONS, MAX_FILENAME_LENGTH, MAX_RESIZE_WIDTH_LIMIT } from '../medias.constants.js';\n\n/**\n * Common validation refinements for file names (security-critical, always applied)\n */\nconst commonFileNameRefinements = (schema: z.ZodString) =>\n  schema\n    .min(1, 'File name is required')\n    .max(MAX_FILENAME_LENGTH, 'File name is too long')\n    .refine(\n      (val) => {\n        // Prevent path traversal attacks\n        const sanitized = val.replace(/\\\\/g, '/');\n        return !sanitized.includes('../') && !sanitized.includes('/..') && !sanitized.startsWith('/');\n      },\n      {\n        message: 'Invalid file name - path traversal detected',\n      },\n    )\n    .refine(\n      (val) => {\n        // Ensure valid file extension\n        const ext = val.toLowerCase().match(/\\.[a-z0-9]+$/)?.[0];\n        return ext ? ALL_MEDIA_EXTENSIONS.includes(ext) : false;\n      },\n      {\n        message: `Invalid file extension - allowed extensions: ${ALL_MEDIA_EXTENSIONS.join(', ')}`,\n      },\n    );\n\n/**\n * Strict filename validation (whitelist approach - default)\n * Only allows: a-z, A-Z, 0-9, dots, hyphens, underscores, forward slashes\n */\nconst strictFilenameRefinement = (val: string) => /^[a-zA-Z0-9._/-]+$/.test(val);\n\n/**\n * Loose filename validation (blacklist approach)\n * Blocks only control characters (0x00-0x1F)\n * Allows: spaces, parentheses, apostrophes, Unicode, etc.\n */\n// eslint-disable-next-line no-control-regex\nconst looseFilenameRefinement = (val: string) => !/[\\x00-\\x1F]/.test(val);\n\n/**\n * Create a GetMediaParams schema with configurable strictness\n * @param strict - When true (default), uses whitelist validation. When false, uses blacklist (loose) validation.\n */\nexport const createGetMediaParamsSchema = (strict = true) =>\n  z.object({\n    fileName: commonFileNameRefinements(z.string()).refine(strict ? strictFilenameRefinement : looseFilenameRefinement, {\n      message: strict ? 'File name contains invalid characters - only alphanumeric, dots, hyphens, underscores, and slashes are allowed' : 'File name contains invalid control characters',\n    }),\n  });\n\n/**\n * Zod schema for media file path parameters with strict security validation (default)\n * Uses whitelist approach - only alphanumeric, dots, hyphens, underscores, and slashes are allowed.\n * Security checks (path traversal, extensions) are always applied.\n *\n * For loose mode validation (backward compatibility with existing S3 files),\n * use createGetMediaParamsSchema(false) or GetMediaParamsLooseDto\n */\nconst GetMediaParamsSchema = createGetMediaParamsSchema(true);\n\n/**\n * Loose mode schema for backward compatibility with existing S3 files\n * Accepts Unicode, spaces, parentheses, etc.\n */\nconst GetMediaParamsLooseSchema = createGetMediaParamsSchema(false);\n\n/**\n * Zod schema for optional size query parameter (for image resizing)\n */\nconst GetMediaQuerySchema = z.object({\n  size: z\n    .string()\n    .optional()\n    .refine(\n      (val) => {\n        if (!val) return true;\n        const num = parseInt(val, 10);\n        return !isNaN(num) && num > 0 && num <= MAX_RESIZE_WIDTH_LIMIT;\n      },\n      {\n        message: `Size must be a positive integer between 1 and ${MAX_RESIZE_WIDTH_LIMIT}`,\n      },\n    ),\n});\n\n/** Strict mode DTO (default) - only alphanumeric, dots, hyphens, underscores, slashes */\nexport class GetMediaParamsDto extends createZodDto(GetMediaParamsSchema) {}\n\n/** Loose mode DTO - accepts Unicode, spaces, parentheses, etc. */\nexport class GetMediaParamsLooseDto extends createZodDto(GetMediaParamsLooseSchema) {}\n\nexport class GetMediaQueryDto extends createZodDto(GetMediaQuerySchema) {}\n"]}